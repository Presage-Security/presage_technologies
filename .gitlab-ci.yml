include:
  - template: 'Workflows/MergeRequest-Pipelines.gitlab-ci.yml'
  - template: 'Workflows/Branch-Pipelines.gitlab-ci.yml'

stages:
  - pre
  - semantic_release

# Grabs tokens to write Semantic Release back to repo
prebuild:
  rules:
  - if: '$CI_COMMIT_BRANCH != "main"'
    when: never
  - if: '$CI_COMMIT_BRANCH == "main"'
  stage: pre
  image: clevy/awssecrets
  script:
    - awssecrets --region us-east-1 --secret gitlab/automation/write_token >> .ci-secrets
  artifacts:
    expire_in: 20 min
    paths:
      - .ci-secrets

secret_detection:
  stage: pre
  image:
    name: ubuntu
    entrypoint: [""]
  services:
    - docker:dind
  before_script:
    - apt update
    - apt install wget curl -y
  script:
    - curl -s  https://api.github.com/repos/zricethezav/gitleaks/releases/latest | grep browser_download_url  |  cut -d '"' -f 4  | grep '\linux-amd64$'| wget -i -
    - mv gitleaks-linux-amd64 gitleak && chmod +x gitleaks
    - gitleaks detect --report-format json --report-path "results.json
semantic_release:
  rules:
  - if: '$CI_COMMIT_BRANCH != "main"'
    when: never
  - if: '$CI_COMMIT_BRANCH == "main"'
  stage: semantic_release
  image:
    name: amazon/aws-cli
    entrypoint: [""]
  services:
    - docker:dind
  before_script:
    - amazon-linux-extras enable python3.8
    - yum install git python3.8 -y
    - curl -O "https://bootstrap.pypa.io/get-pip.py"
    - python3.8 --version
    - python3.8 get-pip.py --user
    - export PATH="$PATH:/root/.local/bin"
    - pip --version
  script:
    - export $(cat .ci-secrets | xargs)
    - pip3 install python-semantic-release
    - git config --global user.name "automation"
    - git config --global user.email "admins@presagesecurity.com"
    - git config --global push.followtags true
    - git config --global alias.mwps "push -o ci.skip"
    - git status
    - semantic-release publish --verbosity=debug
